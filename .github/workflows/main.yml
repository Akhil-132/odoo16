name: Test and Deploy Odoo 16

on:
  push:
    branches:
      - master  # Change if using another branch

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libxml2-dev libpq-dev libxslt1-dev \
            python3-dev python3-venv python3-pip libldap2-dev libsasl2-dev libtiff5-dev \
            libopenjp2-7-dev libjpeg-dev zlib1g-dev libfreetype6-dev libzip-dev python3-setuptools
          
          python3 -m venv odoo16-venv
          source odoo16-venv/bin/activate
          pip install --upgrade pip wheel
          pip install -r requirements.txt
          deactivate

      - name: Run Odoo Syntax Check
        run: |
          source odoo16-venv/bin/activate
          python odoo-bin --version  # Check if Odoo runs without issues
          deactivate

  deploy:
    needs: test  # This ensures deployment happens ONLY IF test job succeeds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to Remote Server
        run: |
          echo "$SSH_PRIVATE_KEY" > key.pem
          chmod 600 key.pem
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e  # Exit on error
            
            # Ensure Odoo User Exists
            if ! id "odoo16" &>/dev/null; then
              sudo useradd -m -d /opt/odoo -U -r -s /bin/bash odoo
            fi
            sudo mkdir -p /opt/odoo
            sudo chown -R odoo:odoo /opt/odoo

            # Install Dependencies
            sudo apt update && sudo apt install -y \
              build-essential wget git python3-pip python3-dev python3-venv python3-wheel \
              libfreetype6-dev libxml2-dev libzip-dev libsasl2-dev python3-setuptools \
              libjpeg-dev zlib1g-dev libpq-dev libxslt1-dev libldap2-dev libtiff5-dev \
              libopenjp2-7-dev postgresql

            # Set up PostgreSQL User for Odoo
            sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='odoo'" | grep -q 1 || sudo -u postgres createuser -s odoo16

            # Deploy Odoo Code
            sudo -u odoo bash -c '
              cd /opt/odoo
              if [ ! -d "/opt/odoo/.git" ]; then
                git clone https://github.com/Akhil-132/odoo16.git /opt/odoo/
              else
                cd /opt/odoo
                git pull origin main
              fi
            '

            # Set Up Virtual Environment and Install Dependencies
            sudo -u odoo bash -c '
              cd /opt/odoo
              python3 -m venv odoo16-venv
              source odoo16-venv/bin/activate
              pip install wheel
              pip install -r /opt/odoo/requirements.txt
              deactivate
            '

            # Create Odoo Configuration File
            if [ ! -f "/etc/odoo16.conf" ]; then
              echo "[options]
              admin_passwd = m0d1fyth15
              db_host = False
              db_port = False
              db_user = odoo
              db_password = False
              addons_path = /opt/odoo/addons
              xmlrpc_port = 8069" | sudo tee /etc/odoo16.conf > /dev/null
            fi

            # Create and Start Odoo Service
            if [ ! -f "/etc/systemd/system/odoo16.service" ]; then
              echo "[Unit]
              Description=Odoo16
              Requires=postgresql.service
              After=network.target postgresql.service

              [Service]
              Type=simple
              SyslogIdentifier=odoo16
              PermissionsStartOnly=true
              User=odoo
              Group=odoo
              ExecStart=/opt/odoo/odoo16-venv/bin/python3 /opt/odoo/odoo-bin -c /etc/odoo16.conf
              StandardOutput=journal+console

              [Install]
              WantedBy=multi-user.target" | sudo tee /etc/systemd/system/odoo16.service > /dev/null
            fi

            sudo systemctl daemon-reload
            sudo systemctl restart odoo16
            sudo systemctl enable odoo16

            echo "âœ… Odoo 16 Deployment Completed!"
          EOF
